{% extends "base.html" %}

{% block title %}{{ recipe.title }} - Mini-RCPE{% endblock %}

{% block content %}
<div class="recipe-header">
    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <h1 style="margin-bottom: 0.5rem;">{{ recipe.title }}</h1>
        {% if user %}
        <a href="/recipe/{{ recipe.id }}/edit" style="font-size: 0.8em; color: var(--meta-color);">[Edit]</a>
        {% endif %}
    </div>

    {% if recipe.image_filename %}
    <div style="margin-bottom: 1.5rem;">
        <img src="/static/uploads/{{ recipe.image_filename }}" alt="{{ recipe.title }}"
            style="max-width: 100%; height: auto; display: block;">
    </div>
    {% endif %}

    <div class="meta">
        {% if recipe.recipe_mode == 'bread' %}
        <span style="background-color: rgba(100, 150, 255, 0.2); padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.9em;">üçû Bread Mode</span>
        {% if recipe.dough_weight %}
        <span style="margin: 0 0.5rem;">‚Ä¢</span>
        <span>Dough Weight: {{ recipe.dough_weight }}g</span>
        {% endif %}
        <span id="hydration-separator" style="margin: 0 0.5rem; display: none;">‚Ä¢</span>
        <span id="hydration-display"></span>
        <span id="hydration-separator-end" style="margin: 0 0.5rem; display: none;">‚Ä¢</span>
        {% endif %}
        {% if recipe.total_time_minutes %}
        <span>Time: {{ recipe.total_time_minutes }} min</span>
        <span style="margin: 0 0.5rem;">‚Ä¢</span>
        {% endif %}
        <span>Servings: <span id="servings-display">{{ recipe.base_servings }}</span></span>
        {% if recipe.source_url %}
        <span style="margin: 0 0.5rem;">‚Ä¢</span>
        <span><a href="{{ recipe.source_url }}" target="_blank" rel="noopener noreferrer" style="color: var(--meta-color); text-decoration: underline;">Source</a></span>
        {% endif %}

        <div style="margin-top: 0.5rem;">
            <label for="scale-select" style="font-size: 0.9em; margin-right: 0.5rem;">Scale:</label>
            <select id="scale-select" onchange="scaleRecipe(this.value)"
                style="font-family: var(--font-mono); font-size: 0.9em; padding: 0.2rem;">
                <option value="0.5">0.5x</option>
                <option value="1" selected>1x</option>
                <option value="2">2x</option>
                <option value="3">3x</option>
            </select>
        </div>
    </div>
</div>

<div class="ingredients-summary">
    <h3>Ingredients</h3>
    <ul>
        {% for step in recipe.steps %}
        {% for ingredient in step.ingredients %}
        <li class="ingredient-item" data-base-amount="{{ ingredient.amount }}"
            data-base-unit="{{ ingredient.unit if ingredient.unit else '' }}"
            data-name="{{ ingredient.ingredient_name }}">
            <span class="amount">{{ ingredient.amount if ingredient.amount else '' }}</span>
            <span class="unit">{{ ingredient.unit if ingredient.unit else '' }}</span>
            <span class="name">{{ ingredient.ingredient_name }}</span>
            {% if recipe.recipe_mode == 'bread' and ingredient.baker_percentage %}
            <span style="color: var(--meta-color); font-size: 0.85em; margin-left: 0.3rem;">({{ ingredient.baker_percentage }}%)</span>
            {% endif %}
        </li>
        {% endfor %}
        {% endfor %}
    </ul>
</div>

<div class="steps">
    <h3>Preparation</h3>
    {% for step in recipe.steps %}
    <div class="step">
        <div class="step-header">
            <span class="step-number">{{ step.step_number }}.</span>
            <div class="step-content">
                <span class="step-action">{{ step.action }}</span>
                {% if step.image_filename %}
                <div style="margin-top: 0.5rem; margin-bottom: 0.5rem;">
                    <img src="/static/uploads/{{ step.image_filename }}" alt="Step {{ step.step_number }}"
                        style="max-width: 100%; height: auto; display: block;">
                </div>
                {% endif %}

                {% if step.ingredients %}
                <div style="margin-top: 0.5rem; margin-bottom: 0.5rem;">
                    <ul style="margin: 0; padding-left: 1.2rem; font-size: 0.9em; color: var(--meta-color);">
                        {% for ingredient in step.ingredients %}
                        <li class="ingredient-item" data-base-amount="{{ ingredient.amount }}"
                            data-base-unit="{{ ingredient.unit if ingredient.unit else '' }}"
                            data-name="{{ ingredient.ingredient_name }}">
                            <span class="amount">{{ ingredient.amount if ingredient.amount else '' }}</span>
                            <span class="unit">{{ ingredient.unit if ingredient.unit else '' }}</span>
                            <span class="name">{{ ingredient.ingredient_name }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {% if step.time_minutes %}
                <span class="step-meta">({{ step.time_minutes }} min)</span>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<script>
    const baseServings = {{ recipe.base_servings }};
    let conversionData = [];

    // Fetch conversion data on load
    fetch('/api/conversions')
        .then(response => response.json())
        .then(data => {
            conversionData = data;
            initConversions();
        })
        .catch(err => console.error('Error fetching conversions:', err));

    function initConversions() {
        const ingredients = document.querySelectorAll('.ingredient-item');
        ingredients.forEach(el => {
            const name = el.dataset.name.toLowerCase();
            const unit = el.dataset.baseUnit.toLowerCase().replace(/s$/, ''); // Simple singularization

            // Find matching conversion
            const conversion = conversionData.find(c => name.includes(c.name.toLowerCase()));

            if (conversion && conversion.common_units[unit]) {
                // Store conversion info
                el.dataset.density = conversion.density_g_per_ml;
                el.dataset.mlPerUnit = conversion.common_units[unit];
                el.dataset.isConverted = "false";

                // Add toggle button
                const btn = document.createElement('button');
                btn.innerText = '‚Üî';
                btn.className = 'conversion-toggle';
                btn.style.marginLeft = '0.5rem';
                btn.style.cursor = 'pointer';
                btn.style.border = '1px solid var(--border-color)';
                btn.style.background = 'none';
                btn.style.borderRadius = '4px';
                btn.style.padding = '0 2px';
                btn.style.fontSize = '0.8em';
                btn.title = 'Toggle Mass/Volume';

                btn.onclick = () => toggleConversion(el);
                el.appendChild(btn);
            }
        });
    }

    function toggleConversion(el) {
        const isConverted = el.dataset.isConverted === "true";
        el.dataset.isConverted = isConverted ? "false" : "true";
        updateIngredient(el);
    }

    function updateIngredient(el) {
        const scaleFactor = parseFloat(document.getElementById('scale-select').value);
        const baseAmount = parseFloat(el.dataset.baseAmount);

        if (isNaN(baseAmount)) return;

        let amount = baseAmount * scaleFactor;
        let unit = el.dataset.baseUnit;

        if (el.dataset.isConverted === "true") {
            // Convert to grams
            // Mass = Volume(ml) * Density
            // Volume = Amount * ml_per_unit
            const mlPerUnit = parseFloat(el.dataset.mlPerUnit);
            const density = parseFloat(el.dataset.density);

            const totalMl = amount * mlPerUnit;
            const massGrams = totalMl * density;

            amount = massGrams;
            unit = 'g';
        }

        // Rounding logic
        if (amount > 100) {
            amount = Math.round(amount);
        } else if (amount > 10) {
            amount = Math.round(amount * 10) / 10;
        } else {
            amount = Math.round(amount * 100) / 100;
        }

        el.querySelector('.amount').innerText = amount;
        el.querySelector('.unit').innerText = unit;
    }

    function scaleRecipe(factor) {
        factor = parseFloat(factor);

        // Update servings display
        const newServings = Math.round(baseServings * factor * 10) / 10;
        document.getElementById('servings-display').innerText = newServings;

        // Update ingredients
        const ingredients = document.querySelectorAll('.ingredient-item');
        ingredients.forEach(el => {
            updateIngredient(el);
        });
    }

    // Calculate and display hydration for bread mode
    function calculateHydration() {
        const hydrationDisplay = document.getElementById('hydration-display');
        if (!hydrationDisplay) return;

        const ingredients = document.querySelectorAll('.ingredient-item');
        let flourWeight = 0;
        let waterWeight = 0;

        ingredients.forEach(el => {
            const name = el.dataset.name.toLowerCase().trim();
            const amount = parseFloat(el.dataset.baseAmount) || 0;

            // Check if ingredient is flour
            if (name.includes('flour') || name.includes('wheat') || 
                name.includes('rye') || name.includes('spelt') || 
                name.includes('semolina') || 
                name.includes('all-purpose') || name.includes('whole grain')) {
                flourWeight += amount;
            }
            // Check if ingredient is water or liquid
            else if (name.includes('water') || name === 'milk' || name.includes('milk')) {
                waterWeight += amount;
            }
        });

        if (flourWeight > 0) {
            const hydration = Math.round((waterWeight / flourWeight) * 100);
            hydrationDisplay.innerText = `Hydration: ${hydration}%`;
            // Show separators
            const sepBefore = document.getElementById('hydration-separator');
            const sepAfter = document.getElementById('hydration-separator-end');
            if (sepBefore) sepBefore.style.display = '';
            if (sepAfter) sepAfter.style.display = '';
        } else {
            hydrationDisplay.innerText = '';
            // Hide separators
            const sepBefore = document.getElementById('hydration-separator');
            const sepAfter = document.getElementById('hydration-separator-end');
            if (sepBefore) sepBefore.style.display = 'none';
            if (sepAfter) sepAfter.style.display = 'none';
        }
    }

    // Calculate hydration on page load
    document.addEventListener('DOMContentLoaded', calculateHydration);
</script>
{% endblock %}