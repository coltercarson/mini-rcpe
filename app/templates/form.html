{% extends "base.html" %}

{% block title %}{% if recipe %}Edit Recipe{% else %}New Recipe{% endif %}{% endblock %}

{% block content %}
<h1 style="margin-bottom: 2rem;">{% if recipe %}Edit Recipe{% else %}New Recipe{% endif %}</h1>

<div style="margin-bottom: 2rem; padding: 1rem; border: 1px solid var(--border-color);">
    <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9em;">Import from URL</label>
    <div style="display: flex; gap: 0.5rem;">
        <input type="url" id="import-url" placeholder="https://example.com/recipe" style="flex: 1;">
        <button type="button" onclick="importRecipe()" style="padding: 0.5rem 1rem;">Import</button>
    </div>
    <div id="import-status" style="margin-top: 0.5rem; font-size: 0.8em; color: var(--meta-color);"></div>
</div>

<form id="recipe-form">
    <div class="form-group">
        <label for="title">Recipe Title</label>
        <input type="text" id="title" name="title" required value="{{ recipe.title if recipe else '' }}">
    </div>

    <div class="form-group">
        <label for="recipe-image">Recipe Image</label>
        <input type="file" id="recipe-image" accept="image/*"
            onchange="uploadImage(this, 'recipe-image-filename', 'recipe-image-preview')">
        <input type="hidden" id="recipe-image-filename" name="image_filename"
            value="{{ recipe.image_filename if recipe and recipe.image_filename else '' }}">
        <div id="recipe-image-preview" style="margin-top: 0.5rem;">
            {% if recipe and recipe.image_filename %}
            <img src="/static/uploads/{{ recipe.image_filename }}" style="max-width: 200px; height: auto;">
            {% endif %}
        </div>
    </div>

    <div class="form-group">
        <label for="total_time_minutes">Total Time (minutes)</label>
        <input type="number" id="total_time_minutes" name="total_time_minutes"
            value="{{ recipe.total_time_minutes if recipe else '' }}">
    </div>

    <div class="form-group">
        <label for="base_servings">Servings</label>
        <input type="number" id="base_servings" name="base_servings"
            value="{{ recipe.base_servings if recipe else 1 }}">
    </div>

    <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 2rem 0;">

    <h3 style="margin-bottom: 1rem;">Steps & Ingredients</h3>
    <div id="steps-container">
        <!-- Steps will be added here -->
    </div>

    <button type="button" class="add-btn" onclick="addStep()">+ Add Step</button>

    <div style="margin-top: 3rem; display: flex; justify-content: space-between;">
        <button type="submit" style="font-weight: bold;">{% if recipe %}Update Recipe{% else %}Save Recipe{% endif
            %}</button>
        {% if recipe %}
        <button type="button" onclick="deleteRecipe()" style="color: red; border-color: red;">Delete Recipe</button>
        {% endif %}
    </div>
</form>

<script>
    let stepCount = 0;
    const initialRecipe = {{ recipe | tojson if recipe else 'null' }};

    async function importRecipe() {
        const urlInput = document.getElementById('import-url');
        const statusDiv = document.getElementById('import-status');
        const url = urlInput.value;

        if (!url) return;

        statusDiv.innerText = "Importing...";

        try {
            const response = await fetch('/api/scrape', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: url })
            });

            if (response.ok) {
                const data = await response.json();

                // Populate fields
                document.getElementById('title').value = data.title || '';
                document.getElementById('total_time_minutes').value = data.total_time_minutes || '';
                document.getElementById('base_servings').value = data.base_servings || 1;

                // Clear existing steps
                document.getElementById('steps-container').innerHTML = '';
                stepCount = 0;

                // Add steps from imported data
                if (data.steps && data.steps.length > 0) {
                    data.steps.forEach(step => addStep(step));
                } else {
                    addStep();
                }

                statusDiv.innerText = "Import successful!";
            } else {
                const err = await response.json();
                statusDiv.innerText = "Error: " + (err.detail || "Failed to import");
            }
        } catch (error) {
            console.error('Error importing:', error);
            statusDiv.innerText = "Error importing recipe";
        }
    }

    async function uploadImage(input, hiddenInputId, previewId) {
        const file = input.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch('/api/upload', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const data = await response.json();
                document.getElementById(hiddenInputId).value = data.filename;

                const preview = document.getElementById(previewId);
                preview.innerHTML = `<img src="/static/uploads/${data.filename}" style="max-width: 200px; height: auto;">`;
            } else {
                alert('Image upload failed');
            }
        } catch (error) {
            console.error('Error uploading image:', error);
            alert('Error uploading image');
        }
    }

    function addStep(data = null) {
        stepCount++;
        const stepId = `step-${stepCount}`;
        const container = document.getElementById('steps-container');

        const stepHtml = `
            <div class="step" id="${stepId}" style="border-bottom: 1px solid var(--border-color); padding-bottom: 2rem; margin-bottom: 2rem;">
                <div class="step-header">
                    <span class="step-number">${stepCount}.</span>
                    <div class="step-content">
                        <div class="form-group">
                            <label>Action / Instruction</label>
                            <textarea name="step_action_${stepCount}" required rows="2">${data ? data.action : ''}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Step Image</label>
                            <input type="file" accept="image/*" onchange="uploadImage(this, 'step-image-${stepCount}', 'step-preview-${stepCount}')">
                            <input type="hidden" id="step-image-${stepCount}" name="step_image_${stepCount}" value="${data && data.image_filename ? data.image_filename : ''}">
                            <div id="step-preview-${stepCount}" style="margin-top: 0.5rem;">
                                ${data && data.image_filename ? `<img src="/static/uploads/${data.image_filename}" style="max-width: 200px; height: auto;">` : ''}
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Time (minutes, optional)</label>
                            <input type="number" name="step_time_${stepCount}" value="${data && data.time_minutes ? data.time_minutes : ''}">
                        </div>
                        
                        <div class="ingredients-list" id="ingredients-${stepId}">
                            <label style="margin-top: 1rem;">Ingredients for this step</label>
                            <!-- Ingredients added here -->
                        </div>
                        <button type="button" class="add-btn" onclick="addIngredient('${stepId}')" style="font-size: 0.8em;">+ Add Ingredient</button>
                    </div>
                </div>
                <button type="button" onclick="removeStep('${stepId}')" style="color: red; border: none; font-size: 0.8em; margin-top: 0.5rem;">Remove Step</button>
            </div>
        `;

        container.insertAdjacentHTML('beforeend', stepHtml);

        if (data && data.ingredients) {
            data.ingredients.forEach(ing => addIngredient(stepId, ing));
        }
    }

    function addIngredient(stepId, data = null) {
        const list = document.getElementById(`ingredients-${stepId}`);
        const count = list.children.length;

        const html = `
            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                <input type="text" placeholder="Name (e.g. Flour)" name="ing_name_${stepId}_${count}" required value="${data ? data.ingredient_name : ''}" style="flex: 2;">
                <input type="number" step="any" placeholder="Amount" name="ing_amount_${stepId}_${count}" value="${data && data.amount ? data.amount : ''}" style="flex: 1;">
                <input type="text" placeholder="Unit" name="ing_unit_${stepId}_${count}" value="${data && data.unit ? data.unit : ''}" style="flex: 1;">
                <button type="button" onclick="this.parentElement.remove()" style="border: none; color: red;">x</button>
            </div>
        `;
        list.insertAdjacentHTML('beforeend', html);
    }

    function removeStep(stepId) {
        document.getElementById(stepId).remove();
    }

    // Initialize form if editing
    if (initialRecipe) {
        initialRecipe.steps.forEach(step => addStep(step));
    } else {
        addStep(); // Start with one empty step
    }

    document.getElementById('recipe-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(e.target);
        const recipe = {
            title: formData.get('title'),
            total_time_minutes: formData.get('total_time_minutes') || null,
            base_servings: formData.get('base_servings') || 1,
            image_filename: formData.get('image_filename') || null,
            steps: []
        };

        const stepsContainer = document.getElementById('steps-container');
        const stepDivs = stepsContainer.getElementsByClassName('step');

        Array.from(stepDivs).forEach((stepDiv, index) => {
            const stepId = stepDiv.id;
            const stepNum = stepId.split('-')[1];

            const action = stepDiv.querySelector(`[name="step_action_${stepNum}"]`).value;
            const time = stepDiv.querySelector(`[name="step_time_${stepNum}"]`).value;
            const image = stepDiv.querySelector(`[name="step_image_${stepNum}"]`).value;

            const step = {
                step_number: index + 1,
                action: action,
                time_minutes: time || null,
                image_filename: image || null,
                ingredients: []
            };

            const ingList = stepDiv.querySelector('.ingredients-list');
            const ingRows = ingList.querySelectorAll('div[style*="display: flex"]');

            ingRows.forEach(row => {
                const nameInput = row.querySelector('input[placeholder*="Name"]');
                const amountInput = row.querySelector('input[placeholder="Amount"]');
                const unitInput = row.querySelector('input[placeholder="Unit"]');

                if (nameInput.value) {
                    step.ingredients.push({
                        ingredient_name: nameInput.value,
                        amount: amountInput.value || null,
                        unit: unitInput.value || null
                    });
                }
            });

            recipe.steps.push(step);
        });

        const url = initialRecipe ? `/api/recipes/${initialRecipe.id}` : '/api/recipes';
        const method = initialRecipe ? 'PUT' : 'POST';

        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(recipe)
            });

            if (response.ok) {
                window.location.href = '/';
            } else {
                alert('Error saving recipe');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error saving recipe');
        }
    });

    async function deleteRecipe() {
        if (!confirm("Are you sure you want to delete this recipe?")) return;

        try {
            const response = await fetch(`/api/recipes/${initialRecipe.id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                window.location.href = '/';
            } else {
                alert('Error deleting recipe');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error deleting recipe');
        }
    }
</script>
{% endblock %}