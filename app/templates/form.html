{% extends "base.html" %}

{% block title %}{% if recipe %}Edit Recipe{% else %}New Recipe{% endif %}{% endblock %}

{% block content %}
<h1 style="margin-bottom: 2rem;">{% if recipe %}Edit Recipe{% else %}New Recipe{% endif %}</h1>

<div style="margin-bottom: 2rem; padding: 1rem; border: 1px solid var(--border-color);">
    <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9em;">Import from URL</label>
    <div style="display: flex; gap: 0.5rem;">
        <input type="url" id="import-url" placeholder="https://example.com/recipe" style="flex: 1;">
        <button type="button" onclick="importRecipe()" style="padding: 0.5rem 1rem;">Import</button>
    </div>
    <div id="import-status" style="margin-top: 0.5rem; font-size: 0.8em; color: var(--meta-color);"></div>
</div>

<form id="recipe-form">
    <div class="form-group" style="margin-bottom: 2rem; padding: 1rem; border: 2px solid var(--border-color); border-radius: 4px; background-color: rgba(0,0,0,0.02);">
        <label style="font-weight: bold; margin-bottom: 0.5rem; display: block;">Recipe Mode</label>
        <div style="display: flex; gap: 1rem;">
            <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="radio" name="recipe_mode" value="normal" id="mode-normal" checked onchange="toggleRecipeMode()">
                <span style="margin-left: 0.5rem;">Normal Recipe</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="radio" name="recipe_mode" value="bread" id="mode-bread" onchange="toggleRecipeMode()">
                <span style="margin-left: 0.5rem;">Bread Baking (Baker's Percentages)</span>
            </label>
        </div>
    </div>

    <div id="bread-mode-fields" style="display: none; margin-bottom: 2rem; padding: 1rem; border: 1px solid var(--border-color); background-color: rgba(100, 150, 255, 0.05);">
        <div class="form-group">
            <label for="dough_weight">Desired Dough Weight (grams)</label>
            <input type="number" step="any" id="dough_weight" name="dough_weight" 
                value="{{ recipe.dough_weight if recipe else '' }}" 
                placeholder="e.g., 1000">
            <small style="display: block; margin-top: 0.25rem; color: var(--meta-color);">
                Enter the total weight of dough you want to make. Flour should be 100%, and other ingredients should be specified as a percentage of the flour weight (Baker's Percentage).
            </small>
            <small style="display: block; margin-top: 0.25rem; color: var(--meta-color); font-style: italic;">
                Example: For a 65% hydration dough, use flour at 100% and water at 65%.
            </small>
        </div>
    </div>

    <div class="form-group">
        <label for="title">Recipe Title</label>
        <input type="text" id="title" name="title" required value="{{ recipe.title if recipe else '' }}">
    </div>

    <div class="form-group">
        <label for="source_url">Source URL (optional)</label>
        <input type="url" id="source_url" name="source_url" placeholder="https://example.com/recipe" value="{{ recipe.source_url if recipe and recipe.source_url else '' }}">
    </div>

    <div class="form-group">
        <label for="recipe-image">Recipe Image</label>
        <input type="file" id="recipe-image" accept="image/*"
            onchange="uploadImage(this, 'recipe-image-filename', 'recipe-image-preview')">
        <input type="hidden" id="recipe-image-filename" name="image_filename"
            value="{{ recipe.image_filename if recipe and recipe.image_filename else '' }}">
        <div id="recipe-image-preview" style="margin-top: 0.5rem;">
            {% if recipe and recipe.image_filename %}
            <img src="/static/uploads/{{ recipe.image_filename }}" style="max-width: 200px; height: auto;">
            {% endif %}
        </div>
    </div>

    <div class="form-group">
        <label for="total_time_minutes">Total Time (minutes)</label>
        <input type="number" id="total_time_minutes" name="total_time_minutes"
            value="{{ recipe.total_time_minutes if recipe else '' }}">
    </div>

    <div class="form-group">
        <label for="base_servings">Servings</label>
        <input type="number" id="base_servings" name="base_servings"
            value="{{ recipe.base_servings if recipe else 1 }}">
    </div>

    <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 2rem 0;">

    <h3 style="margin-bottom: 1rem;">Steps & Ingredients</h3>
    <div id="steps-container">
        <!-- Steps will be added here -->
    </div>

    <button type="button" class="add-btn" onclick="addStep()">+ Add Step</button>

    <div style="margin-top: 3rem; display: flex; justify-content: space-between;">
        <button type="submit" style="font-weight: bold;">{% if recipe %}Update Recipe{% else %}Save Recipe{% endif
            %}</button>
        {% if recipe %}
        <button type="button" onclick="deleteRecipe()" style="color: red; border-color: red;">Delete Recipe</button>
        {% endif %}
    </div>
</form>

<script>
    let stepCount = 0;
    const initialRecipe = {{ recipe | tojson if recipe else 'null' }};

    function toggleRecipeMode() {
        const isBreadMode = document.getElementById('mode-bread').checked;
        const breadFields = document.getElementById('bread-mode-fields');
        
        if (isBreadMode) {
            breadFields.style.display = 'block';
        } else {
            breadFields.style.display = 'none';
        }
        
        // Rebuild all ingredient rows with appropriate fields
        rebuildIngredientRows();
    }

    function rebuildIngredientRows() {
        const stepsContainer = document.getElementById('steps-container');
        const stepDivs = stepsContainer.getElementsByClassName('step');
        
        Array.from(stepDivs).forEach((stepDiv) => {
            const stepId = stepDiv.id;
            const ingList = stepDiv.querySelector('.ingredients-list');
            const ingRows = ingList.querySelectorAll('.ingredient-row');
            
            // Save current data
            const ingredientsData = [];
            ingRows.forEach(row => {
                const nameInput = row.querySelector('input[placeholder*="Name"]');
                const amountInput = row.querySelector('input[name*="ing_amount"]');
                const unitInput = row.querySelector('input[placeholder="Unit"]');
                const bakerInput = row.querySelector('input[name*="ing_baker_percentage"]');
                
                if (nameInput && nameInput.value) {
                    ingredientsData.push({
                        ingredient_name: nameInput.value,
                        amount: amountInput ? parseFloat(amountInput.value) || null : null,
                        unit: unitInput ? unitInput.value : '',
                        baker_percentage: bakerInput ? parseFloat(bakerInput.value) || null : null
                    });
                }
            });
            
            // Remove all ingredient rows except the label
            ingRows.forEach(row => row.remove());
            
            // Re-add with correct fields
            ingredientsData.forEach(data => addIngredient(stepId, data));
        });
    }

    function calculateBakerPercentages() {
        const isBreadMode = document.getElementById('mode-bread').checked;
        if (!isBreadMode) return;
        
        const doughWeight = parseFloat(document.getElementById('dough_weight').value);
        if (!doughWeight || doughWeight <= 0) return;
        
        const stepsContainer = document.getElementById('steps-container');
        const allRows = stepsContainer.querySelectorAll('.ingredient-row');
        
        // Collect all ingredients with their baker's percentages
        const ingredients = [];
        let flourPercentageTotal = 0;
        let otherPercentageTotal = 0;
        
        allRows.forEach(row => {
            const nameInput = row.querySelector('input[placeholder*="Name"]');
            const bakerInput = row.querySelector('input[name*="ing_baker_percentage"]');
            
            if (nameInput && bakerInput) {
                const name = nameInput.value.toLowerCase().trim();
                const percentage = parseFloat(bakerInput.value) || 0;
                
                if (percentage > 0) {
                    const isFlour = name.includes('flour') || name.includes('wheat') || 
                                   name.includes('rye') || name.includes('spelt') || 
                                   name.includes('semolina') || 
                                   name.includes('all-purpose') || name.includes('whole grain');
                    
                    ingredients.push({ row, name, percentage, isFlour });
                    
                    if (isFlour) {
                        flourPercentageTotal += percentage;
                    } else {
                        otherPercentageTotal += percentage;
                    }
                }
            }
        });
        
        if (flourPercentageTotal <= 0) {
            console.log('No flour ingredients found. Baker\'s percentage requires flour at 100% as base.');
            return;
        }
        
        // Calculate total baker's percentage (flour should be at 100% or sum to 100%)
        const totalBakerPercentage = flourPercentageTotal + otherPercentageTotal;
        
        // Calculate flour weight based on total dough weight
        // Total dough = flour_weight * (total_baker_percentage / 100)
        // So: flour_weight = (dough_weight * 100) / total_baker_percentage
        const flourWeight = (doughWeight * 100) / totalBakerPercentage;
        
        // Calculate actual amounts for each ingredient
        ingredients.forEach(({ row, percentage, isFlour }) => {
            const amountInput = row.querySelector('input[name*="ing_amount"]');
            if (amountInput) {
                // Amount = flour_weight * (ingredient_percentage / 100)
                const amount = flourWeight * (percentage / 100);
                amountInput.value = amount.toFixed(1);
            }
        });
    }

    async function importRecipe() {
        const urlInput = document.getElementById('import-url');
        const statusDiv = document.getElementById('import-status');
        const url = urlInput.value;

        if (!url) return;

        statusDiv.innerText = "Importing...";

        try {
            const response = await fetch('/api/scrape', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: url })
            });

            if (response.ok) {
                const data = await response.json();

                // Populate fields
                document.getElementById('title').value = data.title || '';
                document.getElementById('total_time_minutes').value = data.total_time_minutes || '';
                document.getElementById('base_servings').value = data.base_servings || 1;
                document.getElementById('source_url').value = data.source_url || '';

                // Clear existing steps
                document.getElementById('steps-container').innerHTML = '';
                stepCount = 0;

                // Add steps from imported data
                if (data.steps && data.steps.length > 0) {
                    data.steps.forEach(step => addStep(step));
                } else {
                    addStep();
                }

                statusDiv.innerText = "Import successful!";
            } else {
                const err = await response.json();
                statusDiv.innerText = "Error: " + (err.detail || "Failed to import");
            }
        } catch (error) {
            console.error('Error importing:', error);
            statusDiv.innerText = "Error importing recipe";
        }
    }

    async function uploadImage(input, hiddenInputId, previewId) {
        const file = input.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch('/api/upload', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const data = await response.json();
                document.getElementById(hiddenInputId).value = data.filename;

                const preview = document.getElementById(previewId);
                preview.innerHTML = `<img src="/static/uploads/${data.filename}" style="max-width: 200px; height: auto;">`;
            } else {
                alert('Image upload failed');
            }
        } catch (error) {
            console.error('Error uploading image:', error);
            alert('Error uploading image');
        }
    }

    function addStep(data = null) {
        stepCount++;
        const stepId = `step-${stepCount}`;
        const container = document.getElementById('steps-container');

        const stepHtml = `
            <div class="step" id="${stepId}" style="border-bottom: 1px solid var(--border-color); padding-bottom: 2rem; margin-bottom: 2rem;">
                <div class="step-header">
                    <span class="step-number">${stepCount}.</span>
                    <div class="step-content">
                        <div class="form-group">
                            <label>Action / Instruction</label>
                            <textarea name="step_action_${stepCount}" required rows="2">${data ? data.action : ''}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Step Image</label>
                            <input type="file" accept="image/*" onchange="uploadImage(this, 'step-image-${stepCount}', 'step-preview-${stepCount}')">
                            <input type="hidden" id="step-image-${stepCount}" name="step_image_${stepCount}" value="${data && data.image_filename ? data.image_filename : ''}">
                            <div id="step-preview-${stepCount}" style="margin-top: 0.5rem;">
                                ${data && data.image_filename ? `<img src="/static/uploads/${data.image_filename}" style="max-width: 200px; height: auto;">` : ''}
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Time (minutes, optional)</label>
                            <input type="number" name="step_time_${stepCount}" value="${data && data.time_minutes ? data.time_minutes : ''}">
                        </div>
                        
                        <div class="ingredients-list" id="ingredients-${stepId}">
                            <label style="margin-top: 1rem;">Ingredients for this step</label>
                            <!-- Ingredients added here -->
                        </div>
                        <button type="button" class="add-btn" onclick="addIngredient('${stepId}')" style="font-size: 0.8em;">+ Add Ingredient</button>
                    </div>
                </div>
                <button type="button" onclick="removeStep('${stepId}')" style="color: red; border: none; font-size: 0.8em; margin-top: 0.5rem;">Remove Step</button>
            </div>
        `;

        container.insertAdjacentHTML('beforeend', stepHtml);

        if (data && data.ingredients) {
            data.ingredients.forEach(ing => addIngredient(stepId, ing));
        }
    }

    function addIngredient(stepId, data = null) {
        const list = document.getElementById(`ingredients-${stepId}`);
        const count = list.children.length;
        const isBreadMode = document.getElementById('mode-bread').checked;

        let html;
        if (isBreadMode) {
            html = `
                <div class="ingredient-row" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <input type="text" placeholder="Name (e.g. Flour)" name="ing_name_${stepId}_${count}" required value="${data ? data.ingredient_name : ''}" style="flex: 2;">
                    <input type="number" step="any" placeholder="% (flour=100)" name="ing_baker_percentage_${stepId}_${count}" value="${data && data.baker_percentage ? data.baker_percentage : ''}" style="flex: 1;" title="Baker's percentage (flour = 100%)">
                    <input type="number" step="any" placeholder="Amount (g)" name="ing_amount_${stepId}_${count}" value="${data && data.amount ? data.amount : ''}" style="flex: 1;" readonly title="Calculated from percentage">
                    <input type="text" placeholder="Unit" name="ing_unit_${stepId}_${count}" value="${data && data.unit ? data.unit : ''}" style="flex: 1;">
                    <button type="button" onclick="this.parentElement.remove()" style="border: none; color: red;">x</button>
                </div>
            `;
        } else {
            html = `
                <div class="ingredient-row" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <input type="text" placeholder="Name (e.g. Flour)" name="ing_name_${stepId}_${count}" required value="${data ? data.ingredient_name : ''}" style="flex: 2;">
                    <input type="number" step="any" placeholder="Amount" name="ing_amount_${stepId}_${count}" value="${data && data.amount ? data.amount : ''}" style="flex: 1;">
                    <input type="text" placeholder="Unit" name="ing_unit_${stepId}_${count}" value="${data && data.unit ? data.unit : ''}" style="flex: 1;">
                    <button type="button" onclick="this.parentElement.remove()" style="border: none; color: red;">x</button>
                </div>
            `;
        }
        list.insertAdjacentHTML('beforeend', html);
    }

    function removeStep(stepId) {
        document.getElementById(stepId).remove();
    }

    // Initialize form if editing
    if (initialRecipe) {
        // Set recipe mode if available
        if (initialRecipe.recipe_mode) {
            if (initialRecipe.recipe_mode === 'bread') {
                document.getElementById('mode-bread').checked = true;
                toggleRecipeMode();
            }
        }
        initialRecipe.steps.forEach(step => addStep(step));
    } else {
        addStep(); // Start with one empty step
    }

    // Add event listener to dough_weight to recalculate on change
    document.getElementById('dough_weight').addEventListener('input', calculateBakerPercentages);
    
    // Add event listener to recipe mode for calculating when switching modes
    document.addEventListener('input', (e) => {
        if (e.target.name && e.target.name.includes('ing_baker_percentage')) {
            calculateBakerPercentages();
        }
    });

    document.getElementById('recipe-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(e.target);
        const recipe = {
            title: formData.get('title'),
            total_time_minutes: formData.get('total_time_minutes') || null,
            base_servings: formData.get('base_servings') || 1,
            recipe_mode: formData.get('recipe_mode') || 'normal',
            dough_weight: formData.get('dough_weight') || null,
            image_filename: formData.get('image_filename') || null,
            source_url: formData.get('source_url') || null,
            steps: []
        };

        const stepsContainer = document.getElementById('steps-container');
        const stepDivs = stepsContainer.getElementsByClassName('step');

        Array.from(stepDivs).forEach((stepDiv, index) => {
            const stepId = stepDiv.id;
            const stepNum = stepId.split('-')[1];

            const action = stepDiv.querySelector(`[name="step_action_${stepNum}"]`).value;
            const time = stepDiv.querySelector(`[name="step_time_${stepNum}"]`).value;
            const image = stepDiv.querySelector(`[name="step_image_${stepNum}"]`).value;

            const step = {
                step_number: index + 1,
                action: action,
                time_minutes: time || null,
                image_filename: image || null,
                ingredients: []
            };

            const ingList = stepDiv.querySelector('.ingredients-list');
            const ingRows = ingList.querySelectorAll('.ingredient-row');

            ingRows.forEach(row => {
                const nameInput = row.querySelector('input[placeholder*="Name"]');
                const amountInput = row.querySelector('input[name*="ing_amount"]');
                const unitInput = row.querySelector('input[placeholder="Unit"]');
                const bakerPercentageInput = row.querySelector('input[name*="ing_baker_percentage"]');

                if (nameInput && nameInput.value) {
                    step.ingredients.push({
                        ingredient_name: nameInput.value,
                        amount: amountInput && amountInput.value ? parseFloat(amountInput.value) : null,
                        unit: unitInput && unitInput.value ? unitInput.value : null,
                        baker_percentage: bakerPercentageInput && bakerPercentageInput.value ? parseFloat(bakerPercentageInput.value) : null
                    });
                }
            });

            recipe.steps.push(step);
        });

        const url = initialRecipe ? `/api/recipes/${initialRecipe.id}` : '/api/recipes';
        const method = initialRecipe ? 'PUT' : 'POST';

        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(recipe)
            });

            if (response.ok) {
                window.location.href = '/';
            } else {
                alert('Error saving recipe');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error saving recipe');
        }
    });

    async function deleteRecipe() {
        if (!confirm("Are you sure you want to delete this recipe?")) return;

        try {
            const response = await fetch(`/api/recipes/${initialRecipe.id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                window.location.href = '/';
            } else {
                alert('Error deleting recipe');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error deleting recipe');
        }
    }
</script>
{% endblock %}